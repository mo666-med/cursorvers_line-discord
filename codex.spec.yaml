# Codex Spec - Event Rules and Constraints
# This file defines event handling rules, constraints, and delivery logic
# for LINE and note events in a unified specification format.

version: "1.0.0"
description: "LINE and note event orchestration rules"

events:
  line_follow:
    description: "LINE友だち登録イベント"
    source: "line"
    rules:
      - id: "r1"
        condition: "event.type == 'follow'"
        actions:
          - type: "set_tag"
            tag: "conversion_invited"
            value: true
          - type: "send_message"
            template: "welcome"
        constraints:
          - type: "phi_filter"
            enabled: true
          - type: "verified_domain"
            enabled: true

  line_message:
    description: "LINEメッセージイベント"
    source: "line"
    rules:
      - id: "r2"
        condition: "event.type == 'message' && event.message.type == 'text'"
        actions:
          - type: "process_message"
            handler: "gpt_analysis"
        constraints:
          - type: "phi_filter"
            enabled: true

  note_viewed:
    description: "note記事閲覧イベント"
    source: "note"
    rules:
      - id: "r3"
        condition: "event.type == 'viewed_note'"
        actions:
          - type: "update_tag"
            tag: "note_viewed"
            value: true
        constraints:
          - type: "verified_domain"
            enabled: true

  note_payment_completed:
    description: "note決済完了イベント"
    source: "note"
    rules:
      - id: "r4"
        condition: "event.type == 'payment_completed'"
        actions:
          - type: "set_tag"
            tag: "payment_completed"
            value: true
          - type: "send_message"
            template: "payment_thanks"
        constraints:
          - type: "phi_filter"
            enabled: true

constraints:
  phi_filter:
    description: "PHI（個人情報）パターン検出"
    enabled: true
    patterns:
      - type: "email"
        regex: "[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}"
      - type: "phone"
        regex: "0\\d{1,4}-\\d{1,4}-\\d{4}"
      - type: "credit_card"
        regex: "\\d{4}[\\s-]?\\d{4}[\\s-]?\\d{4}[\\s-]?\\d{4}"
    action_on_detect: "remove_and_warn"

  verified_domain:
    description: "Verified Domain検証"
    enabled: true
    allowed_domains:
      - "cursorvers.com"
      - "manus.im"
      - "manus.ai"
    action_on_unverified: "reject"

  broadcast_limit:
    description: "ブロードキャスト送信上限"
    enabled: true
    max_per_user_per_month: 3
    action_on_exceed: "skip"

tags:
  conversion_invited:
    description: "友だち登録済み"
    type: "boolean"
    default: false

  note_viewed:
    description: "note記事閲覧済み"
    type: "boolean"
    default: false

  payment_completed:
    description: "決済完了済み"
    type: "boolean"
    default: false

  last_broadcast_date:
    description: "最後のブロードキャスト送信日"
    type: "date"
    default: null

  broadcast_count_this_month:
    description: "今月のブロードキャスト送信回数"
    type: "integer"
    default: 0

delivery:
  line:
    enabled: true
    webhook_url: "${LINE_WEBHOOK_URL}"
    retry_policy:
      max_retries: 3
      backoff: "exponential"

  discord:
    enabled: false
    webhook_url: "${DISCORD_WEBHOOK_URL}"
    retry_policy:
      max_retries: 3
      backoff: "exponential"

logging:
  enabled: true
  destination: "supabase"
  table: "event_logs"
  artifact_fallback: true
  retention_days: 90


