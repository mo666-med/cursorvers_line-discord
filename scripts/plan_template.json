{
  "title": "Cursor移管 初期セットアップ（Actions主導・Cost-Aware）",
  "risk": {
    "level": "low",
    "reasons": ["設定変更とドキュメント作成のみ"],
    "approval": "not_required"
  },
  "steps": [
    {
      "id": "s1_create_branch",
      "action": "github.create_branch",
      "connector": "github",
      "payload": {
        "owner": "{{OWNER}}",
        "repo": "{{REPO}}",
        "base_branch": "main",
        "new_branch": "handover/cursor-setup"
      },
      "idempotency_key": "gh-branch-handover-cursor-setup",
      "on_error": "abort"
    },
    {
      "id": "s2_commit_files",
      "action": "github.create_or_update_files",
      "connector": "github",
      "payload": {
        "owner": "{{OWNER}}",
        "repo": "{{REPO}}",
        "branch": "handover/cursor-setup",
        "commits": [
          {
            "path": ".cursorrules",
            "message": "chore: add Cursor coding rules",
            "content_b64": "{{BASE64_CURSORRULES}}"
          },
          {
            "path": ".github/workflows/manus-progress.yml",
            "message": "ci: add Manus progress handler (budget guard)",
            "content_b64": "{{BASE64_WORKFLOW_PROGRESS}}"
          },
          {
            "path": ".github/workflows/line-event.yml",
            "message": "ci: add LINE event handler",
            "content_b64": "{{BASE64_WORKFLOW_LINE}}"
          },
          {
            "path": "functions/relay/index.ts",
            "message": "feat: Front Door relay (verify→dispatch)",
            "content_b64": "{{BASE64_FRONTDOOR}}"
          },
          {
            "path": "orchestration/MANUS_EXECUTION_BRIEF_costaware.txt",
            "message": "docs: Manus brief (cost-aware)",
            "content_b64": "{{BASE64_MANUS_BRIEF}}"
          },
          {
            "path": "orchestration/plan/current_plan.json",
            "message": "feat: base Plan (triggers #参加/#完了 etc.)",
            "content_b64": "{{BASE64_CURRENT_PLAN}}"
          },
          {
            "path": "orchestration/cost.py",
            "message": "feat: cost estimator",
            "content_b64": "{{BASE64_COSTPY}}"
          },
          {
            "path": "docs/RUNBOOK.md",
            "message": "docs: ops runbook (stop/recover/rollback)",
            "content_b64": "{{BASE64_RUNBOOK}}"
          },
          {
            "path": "README.md",
            "message": "docs: handover to Cursor (Actions主導)",
            "content_b64": "{{BASE64_README}}"
          }
        ]
      },
      "idempotency_key": "gh-files-handover-cursor-setup",
      "on_error": "abort"
    },
    {
      "id": "s3_open_pr",
      "action": "github.create_pull_request",
      "connector": "github",
      "payload": {
        "owner": "{{OWNER}}",
        "repo": "{{REPO}}",
        "title": "Handover to Cursor: 初期セット＆運用CI導入",
        "head": "handover/cursor-setup",
        "base": "main",
        "body": "Cursor移管の初期セット（.cursorrules / Front Door / Actions / Runbook / Cost Guard ほか）"
      },
      "idempotency_key": "gh-pr-handover-cursor-setup",
      "on_error": "abort"
    },
    {
      "id": "s4_issue_secrets",
      "action": "github.create_issue",
      "connector": "github",
      "payload": {
        "owner": "{{OWNER}}",
        "repo": "{{REPO}}",
        "title": "[運用] Secrets/Vars 登録チェックリスト",
        "body": "- LLM_ENDPOINT\n- LLM_API_KEY\n- MANUS_API_KEY\n- MANUS_BASE_URL\n- VERIFIED_DOMAIN\n- PROGRESS_WEBHOOK_URL\n- CONNECTOR_GCAL / GMAIL / NOTION / SUPABASE / LINEBOT\n- (Front Door) GH_OWNER / GH_REPO / GH_PAT\n- (LINE) CHANNEL_ACCESS_TOKEN / CHANNEL_SECRET\n- (Supabase) URL / SERVICE_ROLE_KEY"
      },
      "idempotency_key": "gh-issue-secrets",
      "on_error": "continue"
    },
    {
      "id": "s5_notion_brief",
      "action": "notion.append",
      "connector": "notion",
      "payload": {
        "page": "{{NOTION_PAGE_CURSOR_HANDOVER}}",
        "content_md": "# Cursor移管チェックリスト\n- PR: handover/cursor-setup をレビュー\n- Secrets投入（上のIssue参照）\n- Front DoorのデプロイとURL切替\n- E2Eテスト（#参加/#完了）\n- Runbook周知・棚卸"
      },
      "idempotency_key": "notion-brief-handover",
      "on_error": "continue"
    },
    {
      "id": "s6_calendar_slot",
      "action": "calendar.create",
      "connector": "google_calendar",
      "payload": {
        "summary": "Cursor移管レビュー（技術）",
        "start": "{{CAL_START_ISO}}",
        "end": "{{CAL_END_ISO}}",
        "attendees": ["{{STAKEHOLDER_EMAILS}}"],
        "description": "PRレビューと運用チェック。"
      },
      "idempotency_key": "cal-handover-meeting",
      "on_error": "continue"
    },
    {
      "id": "s7_notify_admin",
      "action": "gmail.send",
      "connector": "gmail",
      "payload": {
        "to": "{{STAKEHOLDER_EMAILS}}",
        "subject": "Cursor移管：PR作成済みと運用タスク",
        "body": "PRを作成しました。READMEとRUNBOOKに作業手順があります。承認後、Front DoorのURL切替とSecrets投入をお願いします。\n\n【医療安全ガードレール】このアカウントは医療者ではありません。診断/治療/用量等の個別助言は行いません。一般情報の整理と安全案内のみ提供します。緊急の疑いがあれば直ちに救急へ。個人が特定され得る情報は入力しないでください。"
      },
      "idempotency_key": "mail-handover-notify",
      "on_error": "continue"
    }
  ],
  "rollback": [
    "未マージのPRは閉じる",
    "作成したブランチ handover/cursor-setup を削除",
    "Notionのチェックリスト項目を『保留』に変更",
    "カレンダー招待をキャンセル（通知付）"
  ],
  "observability": {
    "success_metrics": [
      "PRが作成されレビュー可能",
      "Secrets用Issueが作成",
      "Notion/Calendar/Gmailが送達（任意）"
    ],
    "logs": ["GitHub API呼び出し結果／HTTPコード／resourceURI"]
  }
}
